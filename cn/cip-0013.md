| cip  | title                                 | author | status |
| ---- | ------------------------------------- | ------ | ------ |
| 0013 | 钱包App通过二维码对网站进行授权的规范 |        | 草案   |

## 概述

手机App通过扫描网站上呈现的二维码来对某种操作进行授权是非常常见的功能。大多数主流网站都有对应的手机App，在PC上登陆网站时，通过手机App来扫码登录，相对于使用密码，更加安全和方便。此外，这一功能也被用于第三方登录，例如很多网站都可以通过微信扫码登录。

本规范描述支持CoinEx Chain的钱包App如何实现类似的功能，即代表CoinEx Chain上的账户对网站进行授权。

## 背景

CoinEx Chain上的账户能够设置可读性好的Alias，同时钱包App安全地保管着账户的私钥。账户的Alias可以作为登录第三方网站的账户，而使用私钥生成的签名，可以作为登录授权的凭证。因此，钱包App进行“扫码授权”的基础是完备的。

## 目的

本文规范了第三方网站经由钱包App进行“扫码授权”时涉及到的数据格式和操作。

## 规范

第三方网站通过二维码呈现的字符串应当是一个URI，其格式是：

```
cet://authorize/<hex-rand-num>/<alias>?target=<url>
```

其中，`hex-rand-num`是一个160位的随机数，采用十六进制编码；`url`是一个http地址，采用[百分号编码](https://en.wikipedia.org/wiki/Percent-encoding)；`alias`是CoinEx Chain上某账户的Alias，当网站不限定对某个特定账户进行授权时，`<alias>`部分为空。

通过扫描得到上述URI之后，钱包App应当做如下操作：

1. 当`alias`不为空时，应检查自己是否保存了这个用户的私钥，若没有则报错；当`alias`为空时，应询问用户使用那个账户的私钥进行签名。
2. 在本地生成一个256位的随机数`local-rand-num`。
3. 将`local-rand-num`和`hex-rand-num`表示为little-endian的字节串，串接后用用Blake2b算法处理，得到一个256位的哈希值，然后使用指定账户的私钥对这个哈希值进行签名。
4. 向上述的`url`发送HTTP POST请求。请求的Body包括四行：第一行是上述`hex-rand-num`；第二行是用户的Alias；第三行是`local-rand-num`；第四行是签名的字节串，采用base64格式编码。网站收到请求后会检查签名，通过后发送“200 OK”的HTTP响应。

上述的URI，不但可以通过二维码进行呈现，还可以作为普通的链接进行点击。这样，对于手机浏览器上打开的网站，用户可以通过点击链接来启动手机App，从而进行登录的授权。