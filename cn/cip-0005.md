| cip  | title                  | author | status |      |
| ---- | ---------------------- | ------ | ------ | ---- |
| 0005 | sync模式执行逻辑的变更 |        | 草案   |      |



## 概述

本文描述了对sync模式执行逻辑的变更。



## 目的

发送交易的时候，在检查交易的签名与gas费是否足够的基础上，增加交易的基本执行逻辑是否能够成功的检查。该服务主要针对钱包运营商提供。



## 背景

在开发全节点的时候，用Golang写的Message Handler一般都比较复杂，包含着很多的检查，以便让那些不合法的Message失败掉。钱包开发者需要在他们的App中，用其他语言（JavaScript、Java、Swift等）再实现一遍这些检查逻辑，这样才能保证App所广播出来的交易最终可以成功执行，而不是在链上失败掉，白白浪费Gas费。这对于钱包开发者而言，是个不小的负担。

造成这一现状的原因，根本上在于Cosmos-SDK只对那些已经被打包进块的交易执行Message Handler，而在控制交易是否进Mempool的时候，只检查签名和基本的Gas费。目前，钱包普遍使用Sync模式，即一个交易能进入Mempool，就向用户反馈“执行成功”。如果在进Mempool的时候，就运行Message Handler来进行详尽的检查，即可避免掉白白浪费Gas费的情况，让钱包开发者不再需要做那么多的检查。



## 实现

增加一个全节点的启动选项`--check-tx-with-msg-handle`，让全节点可以控制CheckTx的行为，在`--check-tx-with-msg-handle=false`时只运行基本的签名和gas检查，`--check-tx-with-msg-handle=true`时额外执行Message Handler的逻辑。

这样，钱包运营者就可以在自己的后台运行打开这种配置选项的全节点，来帮助自己的App把关，让那种注定会在进块之后失败掉的交易，开始时就不要广播出来。

需要注意的是，`--check-tx-with-msg-handle`开启之后，由于需要执行tx的全部逻辑，会对全节点的性能产生影响。同时，开启该选项时，在提交一个区块之后，节点的mempool会被清空，从零开始收集交易。因此validator节点不可开启此选项，此选项是钱包运营商专用的。



## 使用

在启动全节点时，使用以下命令：

```bash
cetd start --check-tx-with-msg-handle=true
```

之后，所有在此全节点上进行的sync模式的交易广播都会额外对交易的执行逻辑进行检查。
